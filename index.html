<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>干燥综合征健康管理</title>
    <link rel="stylesheet" href="css/style.css?v=16">
</head>
<body>
    <div id="app">
        <!-- 登录页 -->
        <div id="login-page" class="page active">
            <div class="login-container">
                <div class="logo-section">
                    <div class="logo">SS</div>
                    <h1>干燥综合征健康管理</h1>
                    <p>个人数据采集工具</p>
                </div>
                <div class="form-section">
                    <div class="input-group">
                        <label>用户名</label>
                        <input type="text" id="username-input" placeholder="请输入用户名">
                    </div>
                    <div class="input-group">
                        <label>密码</label>
                        <div class="password-wrapper">
                            <input type="password" id="password-input" placeholder="请输入密码" autocomplete="current-password">
                            <button type="button" class="toggle-password" aria-label="显示密码" aria-pressed="false" onclick="togglePassword()">
                                <svg class="eye-icon eye-on" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M12 5c5.5 0 9.6 4.2 10.9 6.2.2.3.2.7 0 1C21.6 14.8 17.5 19 12 19S2.4 14.8 1.1 12.2c-.2-.3-.2-.7 0-1C2.4 9.2 6.5 5 12 5zm0 2C7.8 7 4.4 10.2 3.2 11.7 4.4 13.2 7.8 17 12 17s7.6-3.8 8.8-5.3C19.6 10.2 16.2 7 12 7zm0 2.5A2.5 2.5 0 1 1 12 14a2.5 2.5 0 0 1 0-5z"/>
                                </svg>
                                <svg class="eye-icon eye-off" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M3.3 2.3 21.7 20.7l-1.4 1.4-3-3C15.8 19.7 13.9 20 12 20 6.5 20 2.4 15.8 1.1 13.2c-.2-.3-.2-.7 0-1 1-1.6 3.3-4 6.5-5.4L1.9 3.7 3.3 2.3zm6.2 6.2c.8-.3 1.6-.5 2.5-.5a4 4 0 0 1 4 4c0 .9-.2 1.7-.5 2.5l-1.6-1.6c.1-.3.1-.6.1-.9a2 2 0 0 0-2-2c-.3 0-.6 0-.9.1L9.5 8.5zm2.5 9.5c-4.2 0-7.6-3.8-8.8-5.3.8-1 2.5-2.8 4.8-4l1.6 1.6a4 4 0 0 0 5.6 5.6l1.6 1.6c-1.3.6-2.9 1-4.8 1z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="handleLogin()">进入系统</button>
                </div>
            </div>
        </div>

        <!-- 患者列表页 -->
        <div id="patient-list-page" class="page">
            <header>
                <h2>患者列表</h2>
                <span class="logout" onclick="handleLogout()">退出</span>
            </header>
            <div class="search-section">
                <input type="text" id="search-input" placeholder="搜索住院号/姓名..." oninput="searchPatients()">
            </div>
            <div class="filter-section">
                <button class="filter-btn active" onclick="filterPatients('all')">全部</button>
                <button class="filter-btn" onclick="filterPatients('not-started')">未开始</button>
                <button class="filter-btn" onclick="filterPatients('in-progress')">进行中</button>
                <button class="filter-btn" onclick="filterPatients('completed')">已完成</button>
                <button class="filter-btn" onclick="filterPatients('excluded')">已剔除</button>
            </div>
            <div class="patient-list" id="patient-list"></div>
            <div class="add-patient-section">
                <button class="btn-add" onclick="showAddPatient()">+ 添加患者</button>
                <button class="btn-export-all" onclick="showExportOptions()">📤 导出数据</button>
                <button class="btn-backup" onclick="showBackupModal()">💾 备份/恢复</button>
            </div>
        </div>

        <!-- 备份恢复弹窗 -->
        <div id="backup-modal" class="modal">
            <div class="modal-content">
                <h3>数据备份与恢复</h3>
                <div class="backup-section">
                    <p class="backup-hint">备份可防止数据丢失，建议定期导出备份文件</p>
                    <button class="btn-backup-action" onclick="exportBackup()">📥 导出备份文件</button>
                    <div class="backup-divider">或</div>
                    <label class="btn-restore-action">
                        📤 导入备份文件
                        <input type="file" id="restore-file" accept=".json" onchange="importBackup(event)" style="display:none;">
                    </label>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideBackupModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 导出选项弹窗 -->
        <div id="export-options-modal" class="modal">
            <div class="modal-content">
                <h3>导出数据选项</h3>
                <div class="export-options">
                    <label class="export-option-item">
                        <input type="checkbox" id="export-include-excluded"> 包含已剔除患者
                    </label>
                    <label class="export-option-item">
                        <input type="checkbox" id="export-anonymize"> 脱敏处理（隐藏姓名/住院号）
                    </label>
                    <div class="export-format-section">
                        <p>导出格式：</p>
                        <label class="export-option-item">
                            <input type="radio" name="export-format" value="long" checked> 长表格式（患者-模块-字段-值）
                        </label>
                        <label class="export-option-item">
                            <input type="radio" name="export-format" value="wide"> 宽表格式（每字段一列，适合统计分析）
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideExportOptions()">取消</button>
                    <button class="btn-confirm" onclick="doExportAll()">确认导出</button>
                </div>
            </div>
        </div>

        <!-- 添加患者弹窗 -->
        <div id="add-patient-modal" class="modal">
            <div class="modal-content">
                <h3>添加新患者</h3>
                <div class="input-group">
                    <label>住院号 *</label>
                    <input type="text" id="new-patient-id" placeholder="请输入住院号">
                </div>
                <div class="input-group">
                    <label>姓名 *</label>
                    <input type="text" id="new-patient-name" placeholder="请输入姓名">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideAddPatient()">取消</button>
                    <button class="btn-confirm" onclick="goToScreening()">下一步：纳排筛查</button>
                </div>
            </div>
        </div>

        <!-- 纳入排除筛查弹窗 -->
        <div id="screening-modal" class="modal">
            <div class="modal-content modal-large">
                <h3>纳入排除标准筛查</h3>
                <p class="screening-hint">请根据患者情况勾选以下条件：</p>
                
                <div class="screening-section">
                    <div class="screening-title inclusion">✓ 纳入标准（需全部满足）</div>
                    <label class="screening-item"><input type="checkbox" id="inc1"> 2014-2024年在中大医院首次确诊原发性干燥综合征</label>
                    <label class="screening-item"><input type="checkbox" id="inc2"> 符合2016 ACR/EULAR分类标准</label>
                    <label class="screening-item"><input type="checkbox" id="inc3"> 有较完整的电子病历记录</label>
                    <label class="screening-item"><input type="checkbox" id="inc4"> 至少有一次随访记录</label>
                    <label class="screening-item"><input type="checkbox" id="inc5"> 有中医四诊资料</label>
                </div>
                
                <div class="screening-section">
                    <div class="screening-title exclusion">✗ 排除标准（任一符合则排除）</div>
                    <label class="screening-item"><input type="checkbox" id="exc1"> 继发性干燥综合征（合并RA、SLE、SSc等）</label>
                    <label class="screening-item"><input type="checkbox" id="exc2"> 严重恶性肿瘤晚期</label>
                    <label class="screening-item"><input type="checkbox" id="exc3"> 关键研究变量严重缺失</label>
                    <label class="screening-item"><input type="checkbox" id="exc4"> 中医四诊资料严重缺失</label>
                </div>
                
                <div class="screening-result" id="screening-result"></div>
                
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="backToAddPatient()">返回</button>
                    <button class="btn-confirm" id="screening-confirm-btn" onclick="confirmScreening()">确认添加</button>
                </div>
            </div>
        </div>

        <!-- 剔除患者弹窗 -->
        <div id="exclude-patient-modal" class="modal">
            <div class="modal-content">
                <h3>剔除患者</h3>
                <p style="color:#6b7280;font-size:14px;margin-bottom:16px;">请选择剔除原因：</p>
                <div class="exclude-reasons">
                    <label class="exclude-option"><input type="radio" name="exclude-reason" value="继发性干燥综合征"> 继发性干燥综合征</label>
                    <label class="exclude-option"><input type="radio" name="exclude-reason" value="合并严重恶性肿瘤"> 合并严重恶性肿瘤</label>
                    <label class="exclude-option"><input type="radio" name="exclude-reason" value="关键变量严重缺失"> 关键变量严重缺失</label>
                    <label class="exclude-option"><input type="radio" name="exclude-reason" value="中医四诊资料缺失"> 中医四诊资料缺失</label>
                    <label class="exclude-option"><input type="radio" name="exclude-reason" value="数据录入错误"> 数据录入错误</label>
                    <label class="exclude-option"><input type="radio" name="exclude-reason" value="other"> 其他原因</label>
                </div>
                <div class="input-group" id="other-reason-group" style="display:none;margin-top:12px;">
                    <input type="text" id="other-reason-input" placeholder="请输入其他原因">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideExcludeModal()">取消</button>
                    <button class="btn-confirm" style="background:linear-gradient(135deg,#ef4444,#f87171);" onclick="confirmExclude()">确认剔除</button>
                </div>
            </div>
        </div>

        <!-- 患者详情页 -->
        <div id="patient-detail-page" class="page">
            <header>
                <span class="back" onclick="backToList()">&lt; 返回</span>
                <h2 id="patient-name-title">患者详情</h2>
                <span class="exclude-btn" onclick="showExcludeModal()">剔除</span>
            </header>
            <div class="patient-overview" id="patient-overview"></div>
            <div class="progress-section">
                <h3>数据采集进度</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-detail">
                    <span class="progress-text" id="progress-text">0/13 项已完成</span>
                    <span class="progress-percent" id="progress-percent">0%</span>
                </div>
                <div class="missing-fields-hint" id="missing-hint" onclick="showMissingFields()"></div>
            </div>
            <div class="module-grid" id="module-list"></div>
            <div class="export-section">
                <button class="btn-export" onclick="exportPatientData()">导出该患者数据</button>
                <button class="btn-review" onclick="showReviewScreening()">📋 复核纳排</button>
                <button class="btn-delete" id="delete-btn" onclick="deletePatient()">🗑️ 永久删除患者</button>
            </div>
        </div>

        <!-- 缺失字段弹窗 -->
        <div id="missing-fields-modal" class="modal">
            <div class="modal-content modal-large">
                <h3>缺失关键字段清单</h3>
                <div id="missing-fields-list" class="missing-fields-list"></div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideMissingFields()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 纳排复核弹窗 -->
        <div id="review-screening-modal" class="modal">
            <div class="modal-content modal-large">
                <h3>纳排复核</h3>
                <div id="review-screening-content"></div>
                <div class="input-group" style="margin-top:12px;">
                    <label>复核原因</label>
                    <input type="text" id="review-reason" placeholder="请输入复核修改原因">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="hideReviewScreening()">取消</button>
                    <button class="btn-confirm" onclick="saveReviewScreening()">保存复核</button>
                </div>
            </div>
        </div>

        <!-- 表单页 -->
        <div id="form-page" class="page">
            <header>
                <span class="back" onclick="backToDetail()">&lt; 返回</span>
                <h2 id="form-title">表单</h2>
                <span class="save" onclick="saveForm()">保存</span>
            </header>
            <div class="form-container" id="form-container"></div>
        </div>
    </div>
    <script src="js/data.js?v=16"></script>
    <script src="js/data2.js?v=16"></script>
    <script src="js/app.js?v=16"></script>
</body>
</html>
